name: "ğŸ“† Monthly tasks"

on:
  schedule:
    - cron: "0 0 1 * *"

  workflow_dispatch:
    inputs:
      year:
        description: "Year"
        required: false
      month:
        description: "Month"
        required: false

jobs:
  run-monthly-tasks:
    name: "ğŸ‘· Run monthly tasks"
    runs-on: ubuntu-latest

    env:
      NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
      GOOGLE_SHEETS_API_KEY: ${{ secrets.GOOGLE_SHEETS_API_KEY }}

    steps:
      - name: "ğŸ“¦ Checkout"
        uses: actions/checkout@v3

      - name: "ğŸ” Set up Bun"
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: "âœ… Install dependencies"
        run: bun install

      - name: "ğŸ’ Create workout key result for given month"
        if: "${{ github.event.inputs.year != '' && github.event.inputs.month != '' }}"
        run: bun run cli create-monthly-workout-key-result -y ${{ github.event.inputs.year }} -m ${{ github.event.inputs.month }}

      - name: "ğŸ’ Create workout key result for current month"
        if: "${{ github.event.inputs.year == '' && github.event.inputs.month == '' }}"
        run: bun run cli create-monthly-workout-key-result

      - name: "ğŸ§˜ Create meditation key result for given month"
        if: "${{ github.event.inputs.year != '' && github.event.inputs.month != '' }}"
        run: bun run cli create-monthly-meditations-key-result -y ${{ github.event.inputs.year }} -m ${{ github.event.inputs.month }}

      - name: "ğŸ§˜ Create meditation key result for current month"
        if: "${{ github.event.inputs.year == '' && github.event.inputs.month == '' }}"
        run: bun run cli create-monthly-meditations-key-result

      - name: "ğŸ‘€ Create observations key result for given month"
        if: "${{ github.event.inputs.year != '' && github.event.inputs.month != '' }}"
        run: bun run cli create-monthly-observations-key-result -y ${{ github.event.inputs.year }} -m ${{ github.event.inputs.month }}

      - name: "ğŸ‘€ Create observations key result for current month"
        if: "${{ github.event.inputs.year == '' && github.event.inputs.month == '' }}"
        run: bun run cli create-monthly-observations-key-result

  deploy:
    name: "â˜ï¸"
    needs: [run-monthly-tasks]
    uses: krimlabs/state-of-being/.github/workflows/cd.yml@master
    secrets: inherit
